<!DOCTYPE html><html lang=en><head><script>null===localStorage.getItem("theme")?document.documentElement.setAttribute("data-theme","light"):document.documentElement.setAttribute("data-theme",localStorage.getItem("theme"))</script><meta charset=UTF-8><meta content="width=device-width" name=viewport><meta content="Astro v2.0.16" name=generator><link href=/favicon.ico rel=icon><link href=/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/manifest.json rel=manifest><meta content="This is a simple example of how to use goroutines to implement a merge sort algorithm." name=description><meta content="CorentinGS - Freelance backend developer" name=og:title><meta content="Personal blog - Freelance backend developer" name=og:description><meta content=website name=og:type><meta content=https://corentings.dev name=og:url><meta content=https://raw.githubusercontent.com/CorentinGS/CorentinGS/main/Banner-metatags.png name=og:image><meta content=summary_large_image name=twitter:card><meta content=https://corentings.dev name=twitter:url><meta content=@CorentinGS name=twitter:creator><meta content="CorentinGS - Freelance backend developer" name=twitter:title><meta content="Personal Blog - Freelance backend developer" name=twitter:description><meta content=https://raw.githubusercontent.com/CorentinGS/CorentinGS/main/Banner-metatags.png name=twitter:image><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href=https://corentings.dev/blog/mergesort-parallel rel=alternate hreflang=en><link href=https://corentings.dev/fr/blog/mergesort-parallel rel=alternate hreflang=fr><title>Merge Sort using Goroutines</title><link href=/_astro/blog.a35032e3.css rel=stylesheet /><link href=/_astro/docker-and-go.a3203690.css rel=stylesheet /><script src=/_astro/hoisted.56635e58.js type=module></script><script src=/_astro/page.122b1ee3.js type=module></script><script>"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js")</script></head><body><main><div class=drawer><input class=drawer-toggle id=my-drawer-3 type=checkbox><div class="flex flex-col drawer-content"><div class="bg-base-200 navbar"><div class=navbar-start><div class="flex-none lg:hidden"><label class="btn btn-ghost btn-square" for=my-drawer-3><svg class="h-6 inline-block stroke-current w-6" viewBox="0 0 24 24" fill=none xmlns=http://www.w3.org/2000/svg><path d="M4 6h16M4 12h16M4 18h16" stroke-linecap=round stroke-linejoin=round stroke-width=2></path></svg></label></div><a href=/ rel=prefetch class="hoveranimation btn btn-ghost lg:text-3xl normal-case text-xl"><h1 class="font-bold text-secondary">Corentin GS</h1></a></div><div class="lg:flex hidden navbar-end text-xl"><ul class="menu menu-horizontal p-0"><li class=px-3><select class="w-full bg-base-200 max-w-xs select select-bordered select-md select-secondary text-base-content" data-choose-theme><option disabled=disabled selected=selected>Pick your theme</option><option value=cupcake>cupcake</option><option value=dark>dark</option><option value=forest>forest</option><option value=coffee>coffee</option><option value=dracula>dracula</option><option value=memnix>memnix</option><option value=luxury>luxury</option><option value=retro>retro</option><option value=cyberpunk>cyberpunk</option><option value=synthwave>synthwave</option><option value=winter>winter</option><option value=acid>acid</option></select></li><li><a href=/blog rel="nofollow prefetch" class="hoveranimation hover:text-accent">Blog</a></li><li><a href=/links rel="nofollow prefetch" class="hoveranimation hover:text-accent">Contact</a></li><li><a href=https://github.com/CorentinGS/CorentinGS/blob/main/CorentinGS%20CV.pdf rel="noopener noreferrer nofollow" class="hoveranimation hover:text-accent" target=_blank>Resume</a></li></ul></div></div><div class="w-full relative bg-base-100 min-h-screen p-5"><div class="hoveranimation absolute hidden left-1 lg:block top-[0.5rem] z-10"><a href=/blog rel=prefetch class="btn btn-ghost lg:text-3xl text-xl md:text-2xl"><svg class="h-10 w-10" viewBox="0 0 24 24" height=1.2em width=1.2em><path d="M19 12H5m7 7l-7-7l7-7" stroke-linecap=round stroke-linejoin=round stroke-width=2 fill=none stroke=currentColor></path></svg></a></div><div class="w-full relative max-w-screen-lg mb-4 md:mb-0 mx-auto text-white" style=height:24em><picture><source sizes="(max-width: 512px) 512px, (max-width: 1025px) 1024px, 1515px" srcset="/_image?f=avif&#38;w=512&#38;h=288&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 512w,/_image?f=avif&#38;w=1024&#38;h=576&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 1024w,/_image?f=avif&#38;w=1515&#38;h=852&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 1515w" type=image/avif><source sizes="(max-width: 512px) 512px, (max-width: 1025px) 1024px, 1515px" srcset="/_image?f=webp&#38;w=512&#38;h=288&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 512w,/_image?f=webp&#38;w=1024&#38;h=576&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 1024w,/_image?f=webp&#38;w=1515&#38;h=852&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 1515w" type=image/webp><source sizes="(max-width: 512px) 512px, (max-width: 1025px) 1024px, 1515px" srcset="/_image?f=png&#38;w=512&#38;h=288&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 512w,/_image?f=png&#38;w=1024&#38;h=576&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 1024w,/_image?f=png&#38;w=1515&#38;h=852&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80 1515w" type=image/png><img alt="Merge Sort using Goroutines" class="w-full absolute h-full left-0 object-cover top-0 z-0" decoding=async loading=eager src="/_image?f=png&#38;w=1515&#38;h=852&#38;ar=1.7777777777777777&#38;href=https%3A%2F%2Fimages.unsplash.com%2Fphoto-1465251964418-7035fd8f889a%3Fixlib%3Drb-4.0.3%26ixid%3DMnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8%26auto%3Dformat%26fit%3Dcrop%26w%3D1491%26q%3D80"></picture><div class="absolute left-0 bottom-0 p-4 z-20"><span class="px-4 badge badge-secondary inline-flex items-center justify-center mb-2 py-1 uppercase">Programming</span><h1 class="leading-tight text-4xl">Merge Sort using Goroutines</h1><div class="flex mt-3"><img alt="Corentin Giaufer Saubert" class="h-10 w-10 mr-2 object-cover rounded-full" decoding=async loading=eager src="/_image?q=50&#38;f=webp&#38;w=64&#38;h=64&#38;ar=1%2F1&#38;href=https%3A%2F%2Fraw.githubusercontent.com%2FCorentinGS%2Fcorentings.github.io%2Fmain%2Fpublic%2Fimg%2Favatar.webp" height=64 width=64><div><div class="flex flex-col"><span>Corentin Giaufer Saubert</span> <span>Jan. 15, 2023 ・6 min</span></div></div></div></div></div><div class="max-w-screen-lg mx-auto leading-relaxed lg:px-0 mt-12 px-4 text-lg"><h2 id=parallel-merge-sort-vs-simple-merge-sort>Parallel Merge Sort vs Simple Merge Sort</h2><p>This is a simple example of how to use goroutines to <strong>parallelize</strong> a merge sort algorithm. We compare the performance of a simple merge sort algorithm with a parallel merge sort algorithm that uses goroutines.</p><br/><h2 id=the-merge-sort-algorithm>The Merge Sort Algorithm</h2><p>The merge sort algorithm is a divide and conquer algorithm that recursively splits the input array into two halves, sorts each half, and then merges the two sorted halves into a single sorted array.</p><br/><p>To speed up the merge sort algorithm, we use insertion sort for small subarrays (less than 12 elements).</p><br/><p>The implementation of the algorithm uses generics to allow sorting of any type of numbers.</p><pre class=astro-code style=background-color:#0d1117;overflow-x:auto><code><span class=line><span style=color:#ff7b72>func</span><span style=color:#c9d1d9> MergeSort[T Number](items []T) []T {</span></span>
<span class=line><span style=color:#c9d1d9>	size </span><span style=color:#ff7b72>:=</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>len</span><span style=color:#c9d1d9>(items)</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>if</span><span style=color:#c9d1d9> size </span><span style=color:#ff7b72>&lt;</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>2</span><span style=color:#c9d1d9> {</span></span>
<span class=line><span style=color:#c9d1d9>		</span><span style=color:#ff7b72>return</span><span style=color:#c9d1d9> items</span></span>
<span class=line><span style=color:#c9d1d9>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>if</span><span style=color:#c9d1d9> size </span><span style=color:#ff7b72>&lt;</span><span style=color:#c9d1d9> K {</span></span>
<span class=line><span style=color:#c9d1d9>		</span><span style=color:#ff7b72>return</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>Insertionsort</span><span style=color:#c9d1d9>(items)</span></span>
<span class=line><span style=color:#c9d1d9>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>	middle </span><span style=color:#ff7b72>:=</span><span style=color:#c9d1d9> size </span><span style=color:#ff7b72>/</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>2</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>var</span><span style=color:#c9d1d9> a </span><span style=color:#ff7b72>=</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>MergeSort</span><span style=color:#c9d1d9>(items[:middle])</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>var</span><span style=color:#c9d1d9> b </span><span style=color:#ff7b72>=</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>MergeSort</span><span style=color:#c9d1d9>(items[middle:])</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>return</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>merge</span><span style=color:#c9d1d9>(a, b)</span></span>
<span class=line><span style=color:#c9d1d9>}</span></span></code></pre><br/><h2 id=the-merge-sort-algorithm-with-goroutines>The Merge Sort Algorithm with Goroutines</h2><p>The parallel merge sort algorithm uses <strong>goroutines</strong> to sort the two halves of the input array in parallel.</p><p>To prevent the creation of too many goroutines, we use a <strong>threshold</strong> to determine when to use goroutines. If the size of the input array is less than the threshold, we use a simple merge sort algorithm instead of a parallel one.</p><br/><p>Here we use a threshold of 512 elements. We can benchmark the performance of the algorithm with different thresholds to find the optimal threshold, but we will not do that in this example.</p><pre class=astro-code style=background-color:#0d1117;overflow-x:auto><code><span class=line><span style=color:#8b949e>// ParallelMerge Perform merge sort on a slice using goroutines</span></span>
<span class=line><span style=color:#ff7b72>func</span><span style=color:#c9d1d9> ParallelMerge[T Number](items []T) []T {</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>if</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>len</span><span style=color:#c9d1d9>(items) </span><span style=color:#ff7b72>&lt;</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>2</span><span style=color:#c9d1d9> {</span></span>
<span class=line><span style=color:#c9d1d9>		</span><span style=color:#ff7b72>return</span><span style=color:#c9d1d9> items</span></span>
<span class=line><span style=color:#c9d1d9>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#8b949e>// Use a simple merge sort algorithm if the size of the input array is less than the threshold</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>if</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>len</span><span style=color:#c9d1d9>(items) </span><span style=color:#ff7b72>&lt;</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>512</span><span style=color:#c9d1d9> {</span></span>
<span class=line><span style=color:#c9d1d9>		</span><span style=color:#ff7b72>return</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>MergeSort</span><span style=color:#c9d1d9>(items)</span></span>
<span class=line><span style=color:#c9d1d9>	}</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#8b949e>// Create the wait group to wait for the goroutines to finish</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>var</span><span style=color:#c9d1d9> wg sync.WaitGroup</span></span>
<span class=line><span style=color:#c9d1d9>	wg.</span><span style=color:#79c0ff>Add</span><span style=color:#c9d1d9>(</span><span style=color:#79c0ff>1</span><span style=color:#c9d1d9>)</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>var</span><span style=color:#c9d1d9> middle </span><span style=color:#ff7b72>=</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>len</span><span style=color:#c9d1d9>(items) </span><span style=color:#ff7b72>/</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>2</span><span style=color:#c9d1d9>  </span><span style=color:#8b949e>// Find the middle index of the input array</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>var</span><span style=color:#c9d1d9> a []T                   </span><span style=color:#8b949e>// Create a slice to hold the first half of the input array</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>go</span><span style=color:#c9d1d9> </span><span style=color:#ff7b72>func</span><span style=color:#c9d1d9>() {                </span><span style=color:#8b949e>// Create a goroutine to sort the first half of the input array</span></span>
<span class=line><span style=color:#c9d1d9>		</span><span style=color:#ff7b72>defer</span><span style=color:#c9d1d9> wg.</span><span style=color:#79c0ff>Done</span><span style=color:#c9d1d9>()       </span><span style=color:#8b949e>// Decrement the wait group counter when the goroutine finishes</span></span>
<span class=line><span style=color:#c9d1d9>		a </span><span style=color:#ff7b72>=</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>ParallelMerge</span><span style=color:#c9d1d9>(items[:middle]) </span><span style=color:#8b949e>// Sort the first half of the input array</span></span>
<span class=line><span style=color:#c9d1d9>	}()</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>var</span><span style=color:#c9d1d9> b </span><span style=color:#ff7b72>=</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>ParallelMerge</span><span style=color:#c9d1d9>(items[middle:]) </span><span style=color:#8b949e>// Sort the second half of the input array</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>	wg.</span><span style=color:#79c0ff>Wait</span><span style=color:#c9d1d9>() </span><span style=color:#8b949e>// Wait for the goroutine to finish</span></span>
<span class=line><span style=color:#c9d1d9>	</span><span style=color:#ff7b72>return</span><span style=color:#c9d1d9> </span><span style=color:#79c0ff>merge</span><span style=color:#c9d1d9>(a, b) </span><span style=color:#8b949e>// Merge the two sorted halves</span></span>
<span class=line><span style=color:#c9d1d9>}</span></span></code></pre><br/><h2 id=benchmarking-the-merge-sort-algorithms>Benchmarking the Merge Sort Algorithms</h2><p>Now we can benchmark our merge sort algorithms to compare their <strong>performance</strong>.</p><p>To benchmark the algorithms, we use arrays of different sizes and <strong>measure the time</strong> it takes to sort the arrays.</p><br/><p>To run the benchmark we use the following command:</p><pre class=astro-code style=background-color:#0d1117;overflow-x:auto><code><span class=line><span style=color:#c9d1d9>go </span><span style=color:#79c0ff>test</span><span style=color:#c9d1d9> -bench=. -benchtime 5s </span><span style=color:#ff7b72>&gt;</span><span style=color:#c9d1d9> benchmark.txt </span><span style=color:#ff7b72>&amp;&amp;</span><span style=color:#c9d1d9> benchstat benchmark.txt   </span></span></code></pre><br/><p>Benchstat is a tool that can be used to compare the results of benchmarks.</p><p>The results of the benchmark are as follows:</p><pre class=astro-code style=background-color:#0d1117;overflow-x:auto><code><span class=line><span style=color:#c9d1d9>name                                   time/op</span></span>
<span class=line><span style=color:#c9d1d9>Mergesort/1000                     14.6µs ± 0%</span></span>
<span class=line><span style=color:#c9d1d9>Mergesort/10000                     473µs ± 0%</span></span>
<span class=line><span style=color:#c9d1d9>Mergesort/100000                   6.33ms ± 0%</span></span>
<span class=line><span style=color:#c9d1d9>Mergesort/1000000                  87.4ms ± 0%</span></span>
<span class=line></span>
<span class=line><span style=color:#c9d1d9>MergesortWithGoroutines/1000       18.7µs ± 0%</span></span>
<span class=line><span style=color:#c9d1d9>MergesortWithGoroutines/10000       217µs ± 0%</span></span>
<span class=line><span style=color:#c9d1d9>MergesortWithGoroutines/100000     2.71ms ± 0%</span></span>
<span class=line><span style=color:#c9d1d9>MergesortWithGoroutines/1000000    29.0ms ± 0%</span></span></code></pre><br/><p>As we can see, the parallel merge sort algorithm is <strong>much faster</strong> than the simple merge sort algorithm for <strong>large arrays</strong>.</p><br/><h2 id=why-is-the-parallel-merge-sort-algorithm-faster>Why is the Parallel Merge Sort Algorithm Faster?</h2><p>The parallel merge sort algorithm is faster because it uses goroutines to sort the two halves of the input array in <strong>parallel</strong>. The simple merge sort algorithm sorts the two halves of the input array <strong>sequentially</strong>.</p><br/><p>As discussed in the previous article, the cost of <strong>creating a goroutine can be high</strong>. So we should use a parallel merge sort algorithm only when the size of the input array is <strong>large enough to justify the cost</strong> of creating goroutines.</p><br/><h2 id=conclusion>Conclusion</h2><p>In this example, we have seen how to use <strong>goroutines to parallelize</strong> a merge sort algorithm. We have also benchmarked the performance of the merge sort algorithms to compare their performance. Goroutines are a <strong>powerful tool</strong> that should be used <strong>only when the cost of creating goroutines is justified</strong> by the performance improvement.</p><p>In this example, the code isn’t more complex when using goroutines therefore it’s worth using them.</p><h2 id=code>Code</h2><p>The code for this article can be found on <a href=https://github.com/CorentinGS/go-teaching/tree/main/goroutines_merge_sort class="font-bold text-accent underline">GitHub</a></p></div></div></div><div class=drawer-side><label class=drawer-overlay for=my-drawer-3></label><ul class="bg-base-100 menu overflow-y-auto p-4 w-80"><li><a href=/blog rel="nofollow prefetch">Blog</a></li><li><a href=/links rel="nofollow prefetch">Contact</a></li><li><a href=https://github.com/CorentinGS/CorentinGS/blob/main/CorentinGS%20CV.pdf rel="noopener noreferrer nofollow" target=_blank>Resume</a></li><li class=py-3><select class="w-full bg-base-200 max-w-xs select select-bordered select-md select-secondary text-base-content" data-choose-theme><option disabled=disabled selected=selected>Pick your theme</option><option value=cupcake>cupcake</option><option value=dark>dark</option><option value=forest>forest</option><option value=coffee>coffee</option><option value=dracula>dracula</option><option value=memnix>memnix</option><option value=luxury>luxury</option><option value=retro>retro</option><option value=cyberpunk>cyberpunk</option><option value=synthwave>synthwave</option><option value=winter>winter</option><option value=acid>acid</option></select></li></ul></div></div></main></body></html>